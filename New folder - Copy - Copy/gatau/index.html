<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Plant Expert AI — Chat & Image Detect</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        background: #e9f5e9;
        font-family: "Poppins", sans-serif;
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .chat-wrapper {
        width: 100%;
        max-width: 820px;
        height: 88vh;
        background: #fff;
        border-radius: 14px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
        display: grid;
        grid-template-columns: 1fr 360px;
        overflow: hidden;
      }
      .left {
        display: flex;
        flex-direction: column;
      }
      .header {
        padding: 18px 20px;
        background: linear-gradient(135deg, #4caf50, #3f8f42);
        color: #fff;
      }
      .header h2 {
        margin: 0;
        font-size: 1.25rem;
      }
      .messages {
        flex: 1;
        padding: 18px;
        overflow: auto;
        background: #f7fff7;
      }
      .msg {
        margin-bottom: 16px;
        display: flex;
        align-items: flex-start;
        gap: 10px;
      }
      .msg.user {
        justify-content: flex-end;
      }
      .bubble {
        padding: 12px 14px;
        border-radius: 12px;
        max-width: 78%;
        line-height: 1.4;
        font-size: 0.95rem;
      }
      .msg.bot .bubble {
        background: #fff;
        border: 1px solid #e7efe7;
      }
      .msg.user .bubble {
        background: #4caf50;
        color: #fff;
      }
      .bubble img {
        width: 100%;
        border-radius: 10px;
        margin-top: 8px;
      }
      .typing {
        opacity: 0.75;
        font-style: italic;
      }
      .input-area {
        padding: 14px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .input-area input[type="text"] {
        flex: 1;
        padding: 12px 14px;
        border-radius: 20px;
        border: 2px solid #e6eee6;
        outline: none;
        font-size: 1rem;
      }
      .btn {
        padding: 10px 16px;
        border-radius: 14px;
        border: none;
        background: #4caf50;
        color: #fff;
        font-weight: 600;
        cursor: pointer;
      }
      .btn.alt {
        background: #3f8f42;
      }
      /* right panel */
      .right {
        border-left: 1px solid #f0f6f0;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: #fbfff9;
      }
      .upload-card {
        background: #fff;
        border-radius: 10px;
        padding: 12px;
        border: 1px solid #eef7ee;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .preview {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .thumb {
        width: 120px;
        height: 90px;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #eee;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fafafa;
      }
      .thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .meta {
        font-size: 0.85rem;
        color: #666;
      }
      .labels {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .label-pill {
        background: #ebfff0;
        border: 1px solid #dff3db;
        padding: 6px 8px;
        border-radius: 999px;
        font-size: 0.85rem;
        color: #235423;
      }
      .small {
        font-size: 0.85rem;
        color: #666;
      }
      .error {
        color: #b00020;
      }
      .log {
        font-size: 0.85rem;
        color: #444;
        overflow: auto;
        max-height: 200px;
        padding: 6px;
        border-radius: 8px;
        background: #fff;
        border: 1px solid #f0f6f0;
      }
      @media (max-width: 880px) {
        .chat-wrapper {
          grid-template-columns: 1fr;
        }
        .right {
          order: 2;
        }
      }
    </style>
  </head>
  <body>
    <div class="chat-wrapper">
      <div class="left">
        <div class="header">
          <h2>Plant Expert AI</h2>
          <div style="opacity: 0.95; font-size: 0.9rem">
            Chat + Deteksi Gambar — integrasi n8n
          </div>
        </div>

        <div id="messages" class="messages">
          <div class="msg bot">
            <div class="bubble">
              Halo! Saya Plant Expert AI.<br />Ketik pesan atau unggah foto
              tanaman untuk dideteksi.
            </div>
          </div>
        </div>

        <div class="input-area">
          <input id="textInput" type="text" placeholder="Tulis pesan..." />
          <button id="sendTextBtn" class="btn">Kirim</button>
          <button id="openFileBtn" class="btn alt">Unggah</button>
        </div>
      </div>

      <div class="right">
        <div class="upload-card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <div class="meta">
              <strong>Upload / Kamera</strong>
              <div class="small">Pilih file atau pakai kamera</div>
            </div>
            <div class="small">Max ~2MB (otom. kompres)</div>
          </div>

          <input
            id="fileInput"
            type="file"
            accept="image/*"
            style="display: none"
          />
          <div class="preview" id="preview"></div>

          <div style="display: flex; gap: 8px">
            <button id="sendImageBtn" class="btn">Kirim Gambar</button>
            <button id="clearBtn" class="btn alt">Hapus</button>
          </div>
        </div>

        <div class="upload-card">
          <div class="meta"><strong>Hasil Deteksi</strong></div>
          <div id="detectionResult" class="small">Belum ada deteksi.</div>
          <div id="labels" class="labels"></div>
        </div>

        <div class="upload-card">
          <div class="meta"><strong>Log / Debug</strong></div>
          <div id="log" class="log"></div>
        </div>
      </div>
    </div>

    <script>
      // ===== CONFIG =====
      // GANTI dengan webhook n8n-mu (atau proxy endpoint)
      const WEBHOOK = "https://bahlil.app.n8n.cloud/webhook-test/chatbot1";
      // Jika kamu memakai header Authorization atau custom secret, isi di sini:
      const AUTH_TOKEN = ""; // contoh: "Bearer abc123" atau "Secret xyz"

      // ===== UI refs =====
      const messagesBox = document.getElementById("messages");
      const textInput = document.getElementById("textInput");
      const sendTextBtn = document.getElementById("sendTextBtn");
      const openFileBtn = document.getElementById("openFileBtn");
      const fileInput = document.getElementById("fileInput");
      const preview = document.getElementById("preview");
      const sendImageBtn = document.getElementById("sendImageBtn");
      const clearBtn = document.getElementById("clearBtn");
      const detectionResult = document.getElementById("detectionResult");
      const labelsWrap = document.getElementById("labels");
      const logEl = document.getElementById("log");

      // ===== state =====
      let selectedFile = null;

      // ===== helpers =====
      function log(...args) {
        const s = args
          .map((a) => (typeof a === "object" ? JSON.stringify(a) : String(a)))
          .join(" ");
        logEl.innerText =
          new Date().toISOString() + " — " + s + "\n" + logEl.innerText;
      }

      function addMessage(html, from, metaHtml = "") {
        const div = document.createElement("div");
        div.className = "msg " + from;
        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.innerHTML = html;
        div.appendChild(bubble);
        if (metaHtml) {
          const m = document.createElement("div");
          m.className = "meta";
          m.innerHTML = metaHtml;
          div.appendChild(m);
        }
        messagesBox.appendChild(div);
        messagesBox.scrollTop = messagesBox.scrollHeight;
      }

      function showTyping() {
        hideTyping();
        const t = document.createElement("div");
        t.id = "typing";
        t.className = "msg bot";
        t.innerHTML = `<div class="bubble typing">Plant Expert AI mengetik...</div>`;
        messagesBox.appendChild(t);
        messagesBox.scrollTop = messagesBox.scrollHeight;
      }
      function hideTyping() {
        const t = document.getElementById("typing");
        if (t) t.remove();
      }

      function formatLabels(labels) {
        labelsWrap.innerHTML = "";
        if (!labels || !labels.length) {
          detectionResult.innerText = "Tidak ada label terdeteksi.";
          return;
        }
        detectionResult.innerText = `Menemukan ${labels.length} label.`;
        labels.forEach((l) => {
          const p = document.createElement("div");
          p.className = "label-pill";
          const name = l.name || l.label || l.description || String(l);
          const conf =
            l.confidence || l.score || l.probability
              ? ` — ${(l.confidence || l.score || l.probability).toFixed(2)}`
              : "";
          p.innerText = name + conf;
          labelsWrap.appendChild(p);
        });
      }

      // escape HTML for safety
      function escapeHtml(s) {
        return String(s)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }

      // ==== image compression util ====
      // Returns a Blob of the compressed image (JPEG) with approximate max size.
      async function compressImage(file, maxWidth = 1200, quality = 0.78) {
        if (!file) return null;
        const img = await createImageBitmap(file);
        let { width, height } = img;
        const scale = Math.min(1, maxWidth / width);
        width = Math.round(width * scale);
        height = Math.round(height * scale);
        const canvas = document.createElement("canvas");
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, width, height);
        return new Promise((res) => {
          canvas.toBlob((blob) => res(blob), "image/jpeg", quality);
        });
      }

      // ===== file input handlers =====
      openFileBtn.addEventListener("click", () => fileInput.click());
      fileInput.addEventListener("change", async (e) => {
        const f = e.target.files[0];
        if (!f) return;
        // limit size preview (but compress before sending)
        selectedFile = f;
        preview.innerHTML = "";
        const thumb = document.createElement("div");
        thumb.className = "thumb";
        const img = document.createElement("img");
        img.src = URL.createObjectURL(f);
        thumb.appendChild(img);
        preview.appendChild(thumb);
      });

      clearBtn.addEventListener("click", () => {
        selectedFile = null;
        fileInput.value = "";
        preview.innerHTML = "";
        labelsWrap.innerHTML = "";
        detectionResult.innerText = "Belum ada deteksi.";
      });

      // ===== send text message =====
      async function sendText() {
        const text = textInput.value.trim();
        if (!text) return;
        addMessage(escapeHtml(text), "user");
        textInput.value = "";
        showTyping();
        try {
          const headers = { "Content-Type": "application/json" };
          if (AUTH_TOKEN) headers["Authorization"] = AUTH_TOKEN;
          const res = await fetch(WEBHOOK, {
            method: "POST",
            headers,
            body: JSON.stringify({ message: text, mode: "text" }),
          });
          hideTyping();
          const txt = await res.text();
          if (!res.ok) {
            let err = `Server error ${res.status}`;
            try {
              const j = JSON.parse(txt);
              err = j.error || j.message || JSON.stringify(j);
            } catch {}
            addMessage(
              `<span class="error">⚠️ ${escapeHtml(err)}</span>`,
              "bot"
            );
            log("sendText error", res.status, txt);
            return;
          }
          let payload;
          try {
            payload = JSON.parse(txt);
          } catch {
            payload = { reply: txt };
          }
          handleResponsePayload(payload);
          log("sendText ok", payload);
        } catch (err) {
          hideTyping();
          addMessage(
            `<span class="error">⚠️ Gagal terhubung: ${escapeHtml(
              err.message || err
            )}</span>`,
            "bot"
          );
          log("sendText exception", err);
        }
      }

      // ===== send image message =====
      async function sendImage() {
        if (!selectedFile) {
          alert("Pilih gambar dulu (Unggah).");
          return;
        }
        // preview user thumb
        addMessage(
          `<div class="thumb"><img src="${URL.createObjectURL(
            selectedFile
          )}"></div>`,
          "user"
        );
        showTyping();

        try {
          // compress to reasonable size to save bandwidth
          const compressed = await compressImage(selectedFile, 1200, 0.78);
          const payloadForm = new FormData();
          payloadForm.append(
            "file",
            compressed || selectedFile,
            selectedFile.name || "photo.jpg"
          );
          payloadForm.append("message", "Analisa gambar tanaman");
          payloadForm.append("mode", "image");

          const headers = {};
          if (AUTH_TOKEN) headers["Authorization"] = AUTH_TOKEN;
          // don't set Content-Type; browser will set multipart boundary

          const res = await fetch(WEBHOOK, {
            method: "POST",
            headers,
            body: payloadForm,
          });
          hideTyping();
          if (!res.ok) {
            const txt = await res.text();
            let err = `Server error ${res.status}`;
            try {
              const j = JSON.parse(txt);
              err = j.error || j.message || txt;
            } catch {}
            addMessage(
              `<span class="error">⚠️ ${escapeHtml(err)}</span>`,
              "bot"
            );
            log("sendImage error", res.status, err);
            return;
          }

          // try parse json
          let payload;
          try {
            payload = await res.json();
          } catch (e) {
            const txt = await res.text();
            payload = { reply: txt };
          }
          handleResponsePayload(payload);
          log("sendImage ok", payload);
        } catch (err) {
          hideTyping();
          addMessage(
            `<span class="error">⚠️ Gagal kirim gambar: ${escapeHtml(
              err.message || err
            )}</span>`,
            "bot"
          );
          log("sendImage exception", err);
        }
      }

      // ==== generic handler for server payloads ====
      // expected shapes:
      // { reply: "...", text: "...", image: "...", image_url: "...", images: [...], labels:[{name,confidence}], confidence:0.9 }
      function handleResponsePayload(payload) {
        hideTyping();
        if (!payload) {
          addMessage("⚠️ Respons server kosong", "bot");
          return;
        }
        // text keys
        const replyText =
          payload.reply ||
          payload.text ||
          payload.message ||
          payload.output ||
          null;
        if (replyText) addMessage(escapeHtml(replyText), "bot");

        // images: array or single
        let images = [];
        if (Array.isArray(payload.images)) images = payload.images;
        else if (typeof payload.image === "string") images = [payload.image];
        else if (typeof payload.image_url === "string")
          images = [payload.image_url];

        // handle OpenAI-like b64_json inside images array [{b64_json: "..."}]
        if (
          Array.isArray(payload.images) &&
          payload.images.length &&
          typeof payload.images[0] === "object"
        ) {
          const conv = [];
          payload.images.forEach((it) => {
            if (it.b64_json) conv.push("data:image/png;base64," + it.b64_json);
            else if (it.url) conv.push(it.url);
          });
          if (conv.length) images = conv;
        }

        if (images.length) {
          // insert images as a bot bubble
          const frag = document.createElement("div");
          frag.className = "bubble";
          images.forEach((src) => {
            const img = document.createElement("img");
            img.src = src;
            frag.appendChild(img);
          });
          const div = document.createElement("div");
          div.className = "msg bot";
          div.appendChild(frag);
          messagesBox.appendChild(div);
          messagesBox.scrollTop = messagesBox.scrollHeight;
        }

        // labels
        if (payload.labels) {
          // payload.labels can be array of strings or objects
          let labels = payload.labels;
          if (
            Array.isArray(labels) &&
            labels.length &&
            typeof labels[0] === "string"
          ) {
            labels = labels.map((l) => ({ name: l }));
          }
          formatLabels(labels);
        } else if (payload.detected || payload.tags) {
          // some APIs use other keys
          const arr = payload.detected || payload.tags;
          const normalized = Array.isArray(arr)
            ? arr.map((x) => (typeof x === "string" ? { name: x } : x))
            : [];
          formatLabels(normalized);
        } else if (payload.confidence || payload.score) {
          // single label maybe
          const single = {
            name: payload.label || payload.name || "result",
            confidence: payload.confidence || payload.score,
          };
          formatLabels([single]);
        }

        // meta/logging
        if (payload.raw) log("serverRaw", payload.raw);
      }

      // ===== events =====
      sendTextBtn.addEventListener("click", sendText);
      textInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendText();
      });

      sendImageBtn.addEventListener("click", sendImage);

      // allow clicking thumbnails to open full image
      document.addEventListener("click", (ev) => {
        if (ev.target && ev.target.tagName === "IMG") {
          const src = ev.target.src;
          // open in new tab
          window.open(src, "_blank");
        }
      });

      // initial log
      log("UI ready. WEBHOOK=" + WEBHOOK);

      // ===== Notes for backend / n8n =====
      /* 
      - Pastikan n8n workflow memiliki node "Respond to Webhook" dan mengembalikan JSON:
        contoh:
        {
          "reply": "Ini daun terinfeksi jamur.",
          "labels": [{"name":"leaf spot","confidence":0.83}],
          "images": ["https://.../result.jpg"]
        }

      - Jika n8n memerlukan multipart/form-data parsing, gunakan "Webhook" node set ke POST dan ambil binary data.
      - Jika CORS error muncul (browser blocked), gunakan proxy backend (Node/Express) yang memanggil n8n secara server-to-server.
    */
    </script>
  </body>
</html>
